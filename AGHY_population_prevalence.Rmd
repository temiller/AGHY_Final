---
title: "AGHY population prevalence analysis"
author: "Tom Miller"
date: "December 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

#Purpose
I am interested to look at the prevelance dynamics a little differently than we have in the past. I have some ideas for new ways to visualize the data that I would like to try. This file does not do any new computations or model fitting, just runs with the Bayesian fits that we have already completed and saved. Starting with a load of the RData file that includes the most recent fit of the big model. This is is the Dropbox but not on git.

```{r load Bayesian output, echo=T}
load("C:/Users/tm9/Dropbox/AGHY_SFAEF_Project/AGHY analysis summer2017/AGHY_Final/AGHY_Bayes.RData")
```

Here is Marion's lovely combo plot of the inter-annual changes. 
```{r}
ggplot(bayes.endo.prev, aes(order, order))+
  geom_point(data = AGHY.plots.all, aes(prob_t, prob_t1)) +
  geom_line(data = bayes.endo.prev, aes(order, y = mean), size =1) + 
  geom_ribbon(data = bayes.endo.prev, aes(order, ymin=low, ymax= high),alpha=0.3) +
  facet_grid(transition~treatment) +
  labs(x = "Endophyte prevalence in year t", y = "Endophyte prevalence in year t+1") 
```
I would like to plot the full time series of prevalence by plot, grouped into initial prevalence categories. The Bayes output should have the mean and CI prevalence for each plot by year. Get this into a format that works for me. 

```{r warngle bayes output}

## here is the full set of posterior values (rows) by plot (columns) in 2014
hold_2014<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.14)
#dim(hold_2014)
colnames(hold_2014)<-unique(y.14.plot)
prev_2014<-hold_2014%>%
  gather(colnames(hold_2014),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2014,newplot = as.numeric(plot))


## same for 2015
hold_2015<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.15)
#dim(hold_2015)
colnames(hold_2015)<-unique(y.15.plot)
prev_2015<-hold_2015%>%
  gather(colnames(hold_2015),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2015,newplot = as.numeric(plot))

## same for 2016
hold_2016<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.16)
#dim(hold_2016)
colnames(hold_2016)<-unique(y.16.plot)
prev_2016<-hold_2016%>%
  gather(colnames(hold_2016),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2016,newplot = as.numeric(plot))

## tie it all together (there was probably a better way to do this)
prev_allyears <- bind_rows(prev_2014,prev_2015,prev_2016)
##lastly, merge in plot treatment info
#str(AGHY.plots)

plot_dat <- AGHY.plots%>%
  select(newplot,
         mean.prev=target_init_freq)%>%
  mutate(year = 2013)

prev_final <- bind_rows(prev_allyears,plot_dat)%>%
  left_join(.,AGHY.plots[,c("newplot","water","transmission","target_init_freq")],by="newplot")

```


Now here is the plot I am after.

```{r}

ggplot(prev_final,aes(x=year,y=mean.prev,color=water,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI,color=water),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=water),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```
I am concerned about combining transmission control and reduction plots in 2013/14. We suspected the trans reduction did not work effectively (because many of the infs that were transferred were empty) but let's see what it looks like. 

```{r}

ggplot(prev_final,aes(x=year,y=mean.prev,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=transmission,size=1.5),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```
Ugh, looks like transmission reduction had an effect. especially from high initial prevalence. Here is what it looks like with only transmission control plots.

```{r}

prev_final%>%
  filter(transmission=="Control")%>%
ggplot(aes(x=year,y=mean.prev,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=water,size=1.5),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```
The decision we need to make is whether to drop transmission reduction plots entirely (from the pevalence change analysis; it should not influence vital rate esimation) or to use all plots but starting from 2014. I think the latter makes more sense, since we could argue that the first transition year was just meant to get the populations started. If I could do it over again I would have removed original plants after the first year. 

Here I would like to look at overall prevalence change from 2014 to 2016.

```{r}
mean_prev<-prev_final%>%
  mutate(year=paste('mean', year,sep="_"))%>%
  select(newplot,water,transmission,mean.prev,year)%>%
  spread(year,mean.prev)
lowCI_prev<-prev_final%>%
  mutate(year=paste('lowCI', year,sep="_"))%>%
  select(newplot,low.CI,year)%>%
  spread(year,low.CI)
highCI_prev<-prev_final%>%
  mutate(year=paste('highCI', year,sep="_"))%>%
  select(newplot,high.CI,year)%>%
  spread(year,high.CI)  

prev_wide <- left_join(left_join(mean_prev,lowCI_prev,by="newplot"),highCI_prev,by="newplot")
prev_wide

```
```{r}

ggplot(prev_wide)+
  geom_point(aes(x=mean_2014,y=mean_2015,color=transmission))+
  geom_point(aes(x=mean_2015,y=mean_2016,color=transmission))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016,color=transmission),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  theme_bw()

```

I am quite happy with this plot. I don't see any big transmission reduction effect from 2014 onward so I think it is fine to ignore this, in which case the final plot would look like.

```{r}
ggplot(prev_wide)+
  geom_point(aes(x=mean_2014,y=mean_2015))+
  geom_point(aes(x=mean_2015,y=mean_2016))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  theme_bw()
```

What if I added 2013/14 but dropped trans reduction plots?

```{r}
prev_wide%>%
  mutate(mean_2013 = ifelse(transmission=="Reduce",NA,mean_2013))%>%
  ggplot()+
  geom_point(aes(x=mean_2013,y=mean_2014))+
  geom_point(aes(x=mean_2014,y=mean_2015))+
  geom_point(aes(x=mean_2015,y=mean_2016))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  geom_segment(aes(x=mean_2013,y=mean_2014,xend=mean_2014,yend=mean_2015),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016),arrow=arrow(length=unit(0.25,"cm")))+
  theme_bw()

```

This is cool. 
What I would like to do next is to fit linear models for all transition years combined with trans reduction plots dropped for 2013 (as in this fig), and plot and year random effects.I will need to code this up in JAGS because we had been doing something a little different. Also note to self that I can approximate eqm prevalence as logit(y-hat) = a/(b-1).
