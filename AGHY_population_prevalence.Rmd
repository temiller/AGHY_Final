---
title: "AGHY population prevalence analysis"
author: "Tom Miller"
date: "December 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(R2jags)
library(mcmcplots)
```

#Purpose
I am interested to look at the prevelance dynamics a little differently than we have in the past. I have some ideas for new ways to visualize the data that I would like to try. This file does not do any new computations or model fitting, just runs with the Bayesian fits that we have already completed and saved. Starting with a load of the RData file that includes the most recent fit of the big model. This is is the Dropbox but not on git.

```{r load Bayesian output, echo=T}
load("C:/Users/tm9/Dropbox/AGHY_SFAEF_Project/AGHY analysis summer2017/AGHY_Final/AGHY_Bayes.RData")
```

Here is Marion's lovely combo plot of the inter-annual changes. 
```{r}
ggplot(bayes.endo.prev, aes(order, order))+
  geom_point(data = AGHY.plots.all, aes(prob_t, prob_t1)) +
  geom_line(data = bayes.endo.prev, aes(order, y = mean), size =1) + 
  geom_ribbon(data = bayes.endo.prev, aes(order, ymin=low, ymax= high),alpha=0.3) +
  facet_grid(transition~treatment) +
  labs(x = "Endophyte prevalence in year t", y = "Endophyte prevalence in year t+1") 
```
I would like to plot the full time series of prevalence by plot, grouped into initial prevalence categories. The Bayes output should have the mean and CI prevalence for each plot by year. Get this into a format that works for me. 

```{r warngle bayes output}

## here is the full set of posterior values (rows) by plot (columns) in 2014
hold_2014<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.14)
#dim(hold_2014)
colnames(hold_2014)<-unique(y.14.plot)
prev_2014<-hold_2014%>%
  gather(colnames(hold_2014),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2014,newplot = as.numeric(plot))


## same for 2015
hold_2015<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.15)
#dim(hold_2015)
colnames(hold_2015)<-unique(y.15.plot)
prev_2015<-hold_2015%>%
  gather(colnames(hold_2015),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2015,newplot = as.numeric(plot))

## same for 2016
hold_2016<-as.data.frame(AGHY.endochange.out$BUGSoutput$sims.list$p.16)
#dim(hold_2016)
colnames(hold_2016)<-unique(y.16.plot)
prev_2016<-hold_2016%>%
  gather(colnames(hold_2016),key="plot",value="prevalence")%>%
  group_by(plot)%>%
  summarize(mean.prev = mean(prevalence),
            low.CI = quantile(prevalence,probs=0.05),
            high.CI = quantile(prevalence,probs=0.95))%>%
  mutate(year=2016,newplot = as.numeric(plot))

## tie it all together (there was probably a better way to do this)
prev_allyears <- bind_rows(prev_2014,prev_2015,prev_2016)
##lastly, merge in plot treatment info
#str(AGHY.plots)

plot_dat <- AGHY.plots%>%
  select(newplot,
         mean.prev=target_init_freq)%>%
  mutate(year = 2013)

prev_final <- bind_rows(prev_allyears,plot_dat)%>%
  left_join(.,AGHY.plots[,c("newplot","water","transmission","target_init_freq")],by="newplot")

```


Now here is the plot I am after.

```{r}

ggplot(prev_final,aes(x=year,y=mean.prev,color=water,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI,color=water),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=water),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```

I am concerned about combining transmission control and reduction plots in 2013/14. We suspected the trans reduction did not work effectively (because many of the infs that were transferred were empty) but let's see what it looks like. 

```{r transmission compare, echo=F}

ggplot(prev_final,aes(x=year,y=mean.prev,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=transmission,size=1.5),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```

Ugh, looks like transmission reduction had an effect. especially from high initial prevalence. Here is what it looks like with only transmission control plots.

```{r transmission control, echo=F}

prev_final%>%
  filter(transmission=="Control")%>%
ggplot(aes(x=year,y=mean.prev,group=newplot))+
  geom_line()+
  geom_linerange(aes(x=year,ymin=low.CI,ymax=high.CI),position=position_dodge(0.3))+
  geom_point(aes(x=year,y=mean.prev,color=water,size=1.5),position=position_dodge(0.3))+
  facet_grid(water~target_init_freq)+
  theme_bw()
  
```

The decision we need to make is whether to drop transmission reduction plots entirely (from the pevalence change analysis; it should not influence vital rate esimation) or to use all plots but starting from 2014. I think the latter makes more sense, since we could argue that the first transition year was just meant to get the populations started. If I could do it over again I would have removed original plants after the first year. 

Here I would like to look at overall prevalence change from 2014 to 2016.

```{r, echo=F}
mean_prev<-prev_final%>%
  mutate(year=paste('mean', year,sep="_"))%>%
  select(newplot,water,transmission,mean.prev,year)%>%
  spread(year,mean.prev)
lowCI_prev<-prev_final%>%
  mutate(year=paste('lowCI', year,sep="_"))%>%
  select(newplot,low.CI,year)%>%
  spread(year,low.CI)
highCI_prev<-prev_final%>%
  mutate(year=paste('highCI', year,sep="_"))%>%
  select(newplot,high.CI,year)%>%
  spread(year,high.CI)  

prev_wide <- left_join(left_join(mean_prev,lowCI_prev,by="newplot"),highCI_prev,by="newplot")

```
```{r vector plot transmission}

ggplot(prev_wide)+
  geom_point(aes(x=mean_2014,y=mean_2015,color=transmission))+
  geom_point(aes(x=mean_2015,y=mean_2016,color=transmission))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016,color=transmission),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  theme_bw()

```

I am quite happy with this plot. I don't see any big transmission reduction effect from 2014 onward so I think it is fine to ignore this, in which case the final plot would look like.

```{r vector plot bw}
ggplot(prev_wide)+
  geom_point(aes(x=mean_2014,y=mean_2015))+
  geom_point(aes(x=mean_2015,y=mean_2016))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  theme_bw()
```

What if I added 2013/14 but dropped trans reduction plots?

```{r vector plot all years}
prev_wide%>%
  mutate(mean_2013 = ifelse(transmission=="Reduce",NA,mean_2013))%>%
  ggplot()+
  geom_point(aes(x=mean_2013,y=mean_2014))+
  geom_point(aes(x=mean_2014,y=mean_2015))+
  geom_point(aes(x=mean_2015,y=mean_2016))+
  geom_segment(aes(0,0,xend=1,yend=1))+
  facet_wrap(~water)+
  geom_segment(aes(x=mean_2013,y=mean_2014,xend=mean_2014,yend=mean_2015),arrow=arrow(length=unit(0.25,"cm")))+
  geom_segment(aes(x=mean_2014,y=mean_2015,xend=mean_2015,yend=mean_2016),arrow=arrow(length=unit(0.25,"cm")))+
  theme_bw()

```

This is cool. 
What I would like to do next is to fit linear models for all transition years combined with trans reduction plots dropped for 2013 (as in this fig), and plot and year random effects.I will need to code this up in JAGS because we had been doing something a little different. Also note to self that I can approximate eqm prevalence as logit(y-hat) = a/(b-1).

Updating the AGHY prevalence Bayesian model:

```{r JAGS model}
sink("AGHY_prevalence_all_years.txt")
cat("
    model{

###################################################################
############### endo prevalence model #####################
###################################################################

    ## Priors
    for(i in 1:N.trt){
    ## Priors for regression coefficients for change in endo prevalence 
    beta0.mean[i]~dnorm(0,0.001)   
    beta1.mean[i]~dnorm(0,0.001)   
    }

    ## coefficients for transmission reduction effect in 2013/14
    beta0.transeffect~dnorm(0,0.001)
    beta1.transeffect~dnorm(0,0.001)

    ## random intercepts for plots
    sigma0.plot~dunif(0,1000)
    sigma1.plot~dunif(0,1000)
    tau.sigma0.plot<-1/(sigma0.plot*sigma0.plot)
    tau.sigma1.plot<-1/(sigma1.plot*sigma1.plot)
    for(i in 1:N.plots){      
    ran.beta0.plot[i]~dnorm(0,tau.sigma0.plot)
    ran.beta1.plot[i]~dnorm(0,tau.sigma1.plot)
    }

    ## random intercepts for years
    sigma0.year~dunif(0,1000)
    sigma1.year~dunif(0,1000)
    tau.sigma0.year<-1/(sigma0.year*sigma0.year)
    tau.sigma1.year<-1/(sigma1.year*sigma1.year)
    for(i in 1:N.years){      
    ran.beta0.year[i]~dnorm(0,tau.sigma0.year)
    ran.beta1.year[i]~dnorm(0,tau.sigma1.year)
    }

    ## Likelihood - plot-level estimation
    ## create a matrix of endo prevalence by plot/year
    for(i in 1:N.plots){
      #this is the 2013/14 transition, which is special b/c starting prev is known
      #I will need to include trans reduce effects here (not yet)
      logit(prev[i,1]) <- beta0.mean[water[i]] + beta0.transeffect*trans_reduce[i] + ran.beta0.plot[plot[i]] + ran.beta0.year[year[1]] + (beta1.mean[water[i]] + beta1.transeffect*trans_reduce[i] + ran.beta1.plot[plot[i]] + ran.beta1.year[year[1]]) * initial_prev[i]

      for(j in 2:N.years){
        logit(prev[i,j]) <- beta0.mean[water[i]] + ran.beta0.plot[plot[i]] +       ran.beta0.year[year[j]] + (beta1.mean[water[i]] + ran.beta1.plot[plot[i]] + ran.beta1.year[year[j]]) * prev[i,j-1]
      }
    }

    ## Likelihood - subplot-level estimation
    for(i in 1:N.obs){
    y.pos[i]~dbinom(prev[plot[i],year[j]],N.samples[i])

    ## Computation of fit statistic (for Bayesian p-value)
     Presi[i] <- abs(y.pos[i] - prev[plot[i],year[j]]*N.samples[i])
     y.new[i] ~ dbinom(prev[plot[i],year[j]],N.samples[i])
     Presi.new[i] <- abs(y.new[i] - prev[plot[i],year[j]]*N.samples[i])
    }
    
    ## Prediction
    for(i in 1:N.x.levels){
    logit(Eplus.add.pred[i])<-beta0.mean[1]+beta1.mean[1]*x.levels[i]
    logit(Eplus.control.pred[i])<-beta0.mean[2]+beta1.mean[2]*x.levels[i]
    }

    ## Posterior predictive check
    fit <- sum(Presi[]) # Discrepancy for actual data set
    fit.new <- sum(Presi.new[]) # Discrepancy for replicate data set


    }##end model
    ",fill=T)
sink()

```

Now let's make a nice and tidy data set to feed into the Bayes model. I am working with the data frame called 'AGHY merge', which is created elsewhere.

```{r bundle data}
AGHY_subplot_dat <- AGHY.merge%>%
  select(newplot,year_t,subplot,water,transmission,target_init_freq,E_plus_liberal,total)%>% na.omit()%>%arrange(year_t,newplot,subplot)

AGHY_plot_dat <- AGHY_dat%>%group_by(newplot)%>%summarize(water = unique(water),transmission = unique(transmission), initial_prev = unique(target_init_freq))%>%mutate(trans_reduce = ifelse(transmission=="Reduce",1,0))%>%  arrange(newplot)

## bundle data

## levels
N.trt<-length(levels(AGHY_subplot_dat$water))
N.years<-length(unique(AGHY_subplot_dat$year_t))
N.plots<-length(unique(AGHY_subplot_dat$newplot))
N.obs<-nrow(AGHY_subplot_dat)

## data - predictor variables at the plot level
water<-AGHY_plot_dat$water
trans_reduce<-AGHY_plot_dat$trans_reduce
initial_prev<-AGHY_plot_dat$initial_prev

## data - response variable at subplot level
y.pos<-AGHY_subplot_dat$E_plus_liberal
N.samples<-AGHY_subplot_dat$total
plot<-AGHY_subplot_dat$newplot
year<-AGHY_subplot_dat$year_t


```

